<div class="container mt-4">
  <% co_author = @proposal.co_authors.find_by(user_id: current_user.id) %>
  <% if co_author&.invited? && co_author.user_id == current_user.id %>
    <div class="d-flex gap-2 mt-2">
      <%= button_to "Accept Invitation", proposal_co_author_path(@proposal, co_author),
          method: :patch,
          params: { status: "accepted", user_id: co_author.user_id },
          class: "btn btn-success btn-sm" %>

      <%= button_to "Decline Invitation", proposal_co_author_path(@proposal, co_author),
          method: :patch,
          params: { status: "declined", user_id: co_author.user_id },
          class: "btn btn-danger btn-sm" %>
    </div>
  <% end %>

  <% if (@proposal.user == current_user || @proposal.co_authors.where(status: %w[invited accepted]).exists?(user: current_user)) && !@proposal.approved_users.include?(current_user) %>
    <%= button_to "Approve Proposal", approve_proposal_path(@proposal), method: :post, class: "btn btn-success" %>
  <% elsif @proposal.approved_users.include?(current_user) %>
    <p><span class="badge bg-success">You have approved this proposal.</span></p>
  <% end %>

  <h2><%= @proposal.title %></h2>
  <p><%= @proposal.description %></p>

  <%= link_to 'Edit', edit_proposal_path(@proposal), class: "btn btn-secondary" %>
  <%= link_to 'Back', proposals_path, class: "btn btn-outline-primary" %>
</div>


<h3>Invite Co-author</h3>

<%= form_with url: proposal_co_authors_path(@proposal), method: :post, local: true do |f| %>
  <div class="mb-2">
    <%= label_tag :email %>
    <%= email_field_tag :email, nil, class: "form-control" %>
  </div>
  <%= submit_tag "Invite", class: "btn btn-primary" %>
<% end %>

<h4 class="mt-4">Co-authors</h4>
<ul class="list-group">
  <% @proposal.co_authors.each do |co_author| %>
    <li class="list-group-item d-flex justify-content-between">
      <%= co_author.user.name %> — <%= co_author.status %>
    </li>
  <% end %>
</ul>

<h4 class="mt-5">Edit History</h4>
<% @proposal.versions.reverse_each do |version| %>
  <div class="card my-2">
    <div class="card-body">
      <p><strong>Changed by:</strong> <%= User.find_by(id: version.whodunnit)&.email || "Unknown" %></p>
      <p><strong>At:</strong> <%= version.created_at.strftime("%d %b %Y, %I:%M %p") %></p>

      <% if version.object_changes.present? %>
        <ul>
          <% version.changeset.each do |field, values| %>
            <li><strong><%= field.humanize %>:</strong> "<%= values[0] %>" → "<%= values[1] %>"</li>
          <% end %>
        </ul>
      <% else %>
        <p>No field-level changes recorded.</p>
      <% end %>
    </div>
  </div>
<% end %>
